<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>To My Valentine — A Celestial Letter</title>

    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&family=Great+Vibes&display=swap" rel="stylesheet">

    <style>
        :root{
            --space-1:#0a0c1a;
            --space-2:#11162a;
            --ink:#e7e4f7;
            --accent:#e9c89d;
            --accent-2:#d7a770;
            --card: rgba(13, 16, 34, .68);
            --shadow: 0 10px 35px rgba(3, 6, 20, .45);
            --radius: 18px;
            --maxw: 860px;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body{
            margin:0;
            color:var(--ink);
            font-family: "Cormorant Garamond", Georgia, "Times New Roman", serif;
            background: radial-gradient(1200px 700px at 15% 20%, #151936, #0b0f22 55%, #060814 100%);
            overflow-x: hidden;
        }

        .bg{
            position: fixed; inset:0; overflow:hidden; z-index:-1;
            background:
                    radial-gradient(1200px 800px at 85% -10%, rgba(120, 74, 184, .18), transparent 70%),
                    radial-gradient(800px 600px at 15% 110%, rgba(52, 168, 145, .14), transparent 70%),
                    radial-gradient(1600px 900px at 20% 30%, rgba(167, 58, 120, .16), transparent 72%),
                    radial-gradient(200% 120% at 50% 50%, rgba(255,255,255,.05), transparent 60%);
            filter: saturate(105%) brightness(1.02);
        }

        .nebula{
            position:absolute; inset:-15vmax;
            background:
                    radial-gradient(60% 40% at 30% 35%, rgba(255,180,255,.07), transparent 65%),
                    radial-gradient(45% 35% at 70% 25%, rgba(120,180,255,.06), transparent 70%),
                    radial-gradient(40% 30% at 50% 70%, rgba(255,140,190,.06), transparent 70%);
            mix-blend-mode: screen;
            animation: drift 60s ease-in-out infinite alternate;
        }
        @keyframes drift{
            0%   { transform: translate3d(0, 0, 0) scale(1); filter: blur(0.5px); }
            100% { transform: translate3d(-2%, 1%, 0) scale(1.03); filter: blur(1px); }
        }

        canvas.stars { position:absolute; inset:0; }

        .vignette{
            position:absolute; inset:-8vmax;
            pointer-events:none;
            background: radial-gradient(120% 120% at 50% 50%, transparent 60%, rgba(0,0,0,.35) 100%);
        }

        .wrap{
            min-height:100svh;
            display:grid;
            place-items:center;
            padding: 32px 16px 48px;
        }

        header.hero{
            text-align:center;
            margin-bottom: 14px;
            user-select: none;
        }
        .hero h1{
            font-family:"Great Vibes", cursive;
            font-weight:400;
            font-size: clamp(38px, 6vw, 64px);
            margin: 6px 0 2px;
            letter-spacing:.5px;
            background: linear-gradient(95deg, #e5c08a, #ffe6b4 45%, #d7a770 70%);
            -webkit-background-clip: text; background-clip: text;
            color: transparent;
            text-shadow: 0 1px 0 rgba(255,255,255,.25), 0 3px 18px rgba(255, 214, 160, .18);
            animation: shimmer 6s ease-in-out infinite;
        }
        @keyframes shimmer{
            0%,100% { filter: drop-shadow(0 2px 0 rgba(255,255,255,.5)); }
            50%     { filter: drop-shadow(0 4px 6px rgba(250,220,150,.35)); }
        }
        .hero .subtitle{
            margin:0;
            font-style: italic;
            color:#d1c7ff;
            opacity:.85;
            text-shadow: 0 1px 10px rgba(120,140,240,.25);
        }

        .envelope{
            position: relative;
            width: min(92vw, 560px);
            height: 360px;
            perspective: 1200px;
            margin: 12px auto 22px;
        }
        .env{
            width:100%; height:100%;
            position:relative;
            border-radius: 14px;
            background: linear-gradient(180deg, #111627, #0f1324 55%, #0c1020 100%);
            border: 1px solid rgba(180,170,255,.18);
            box-shadow: var(--shadow);
            overflow:hidden;
        }
        .env .flap{
            position:absolute; left:0; top:0; right:0; height: 58%;
            background:
                    linear-gradient(180deg, #1b2142, #151b34 85%),
                    linear-gradient(180deg, rgba(255,255,255,.06), transparent 30%);
            clip-path: polygon(0 0, 100% 0, 50% 98%);
            transform-origin: top center;
            transform: rotateX(0);
            transition: transform 1.1s cubic-bezier(.2,.7,.2,1);
            z-index:3;
        }
        .env .pocket{
            position:absolute; inset:36% 0 0 0;
            background: linear-gradient(180deg, #0e1226, #0a0f1f);
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%, 0 12%);
            z-index:1;
        }
        .env .paper{
            position:absolute; left:6%; right:6%; top:18%;
            height: 72%;
            background: linear-gradient(180deg, rgba(20,24,44,.92), rgba(18,22,40,.92));
            border: 1px solid rgba(200,190,255,.18);
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(3,4,12,.45);
            display:grid; place-items:center;
            color:#cfd6ff;
            z-index:2;
            transform: translateY(0);
            transition: transform 1.1s cubic-bezier(.2,.7,.2,1);
            text-align:center;
            padding: 18px;
        }
        .paper-to{
            font-family:"Great Vibes", cursive;
            font-size: clamp(28px, 4.5vw, 38px);
            color:#f3e9ff;
            letter-spacing: .5px;
            text-shadow:
                    0 0 6px rgba(160,140,255,.45),
                    0 0 16px rgba(110,180,255,.25),
                    0 0 36px rgba(110,160,255,.18);
            animation: nameGlow 5.5s ease-in-out infinite;
        }
        .paper .tap-hint{
            margin-top: 6px;
            font-style: italic;
            font-size: 12px;
            opacity:.8;
            color:#cfd6ff;
        }
        @keyframes nameGlow{
            0%,100% { filter: drop-shadow(0 0 4px rgba(140,140,255,.35)); }
            50%     { filter: drop-shadow(0 0 10px rgba(120,200,255,.45)); }
        }

        .env .seal{
            position:absolute; inset:auto 50% 30% auto;
            transform: translateX(50%);
            width:64px; height:64px;
            border-radius: 50%;
            background: radial-gradient(60% 60% at 35% 35%, #ff7aa2, #d84d76 70%, #9e2a4d 100%);
            box-shadow: inset 0 6px 10px rgba(0,0,0,.35), 0 6px 12px rgba(0,0,0,.25);
            display:grid; place-items:center;
            color:#fff;
            font-size:24px;
            letter-spacing:.8px;
            font-weight:700;
            z-index:4;
            transition: transform .9s ease, opacity .9s ease;
        }

        .open-hint{
            position:absolute; inset:auto 0 -38px 0;
            text-align:center; color:#cfd6ff; font-style:italic; font-size:14px; opacity:.85;
        }
        .envelope button.open{
            position:absolute; inset:auto 50% -64px 50%;
            transform: translateX(-50%);
            padding: 10px 18px;
            border-radius: 999px;
            border: 1px solid rgba(200,190,255,.25);
            background: linear-gradient(180deg, #151a30, #101427);
            color:#d9d7ff;
            cursor:pointer;
            transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
            box-shadow: 0 6px 22px rgba(10,12,26,.48);
        }
        .envelope button.open:hover{
            transform: translateX(-50%) translateY(-1px);
            background: linear-gradient(180deg, #192141, #121833);
            box-shadow: 0 10px 30px rgba(16,18,40,.6);
        }

        .envelope.opened .env .flap{ transform: rotateX(-178deg); }
        .envelope.opened .env .paper{ transform: translateY(-120%); }
        .envelope.opened .env .seal{ transform: scale(.6); opacity:0 }

        .panel{
            width: min(92vw, var(--maxw));
            display:none;
            animation: fadeIn .7s ease both;
        }
        .panel.show{ display:block; }
        @keyframes fadeIn{ from{opacity:0; transform: translateY(8px);} to{opacity:1; transform:none;} }

        .card{
            position:relative;
            background: var(--card);
            backdrop-filter: blur(8px) saturate(115%);
            -webkit-backdrop-filter: blur(8px) saturate(115%);
            border-radius: var(--radius);
            border: 1px solid rgba(190,180,255,.18);
            box-shadow: var(--shadow);
            padding: clamp(18px, 3.4vw, 34px);
        }

        .card .topline{
            display:flex; gap:12px; align-items:baseline; justify-content:space-between;
            border-bottom: 1px dashed rgba(190,180,255,.25);
            padding-bottom: 10px; margin-bottom: 14px;
        }
        .dear{
            font-size: clamp(18px, 3.2vw, 28px);
            font-weight: 600; letter-spacing:.2px;
        }
        .date{
            font-size: 14px; color:#bfc6ff; font-style: italic; opacity:.9;
        }

        .scroll-indicator{
            text-align:center; font-size:13px; color:#cdd4ff; opacity:.85;
            margin: 0 0 8px;
            display:flex; align-items:center; gap:6px; justify-content:center;
        }
        .scroll-indicator .arrow{ animation: bob 1.8s ease-in-out infinite; }
        @keyframes bob{ 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(3px);} }

        .body-wrap{ position:relative; }
        .letter{
            max-height: min(60svh, 620px);
            overflow:auto;
            padding-right: 10px;
            line-height: 1.7;
            font-size: clamp(16px, 2.2vw, 20px);
            text-align: left; color: var(--ink);
        }
        .body-wrap::before,
        .body-wrap::after{
            content:"";
            position:absolute; left:0; right:0; height: 24px;
            pointer-events:none; z-index:2;
        }
        .body-wrap::before{ top:-2px; background: linear-gradient(180deg, var(--card), transparent); }
        .body-wrap::after{ bottom:-2px; background: linear-gradient(0deg, var(--card), transparent); }

        .letter p{ margin: 0 0 1em; }
        .letter p:last-child{ margin-bottom:0; }

        .pre-letter{
            white-space: pre-wrap;
            overflow-wrap: anywhere;
            word-wrap: break-word;
            font-family: "Cormorant Garamond", Georgia, "Times New Roman", serif;
            font-size: clamp(16px, 2.2vw, 20px);
            line-height: 1.7;
            margin: 0; padding: 0; color: inherit;
            background: transparent; border: none;
        }
        .pre-letter.handwritten{
            font-family: "Great Vibes", cursive;
            font-size: clamp(22px, 5vw, 28px);
            line-height: 1.5;
            letter-spacing: .2px;
            transform: rotate(-0.2deg);
            text-shadow:
                    0 0.3px 0 rgba(0,0,0,.15),
                    0.5px 0.5px 0 rgba(0,0,0,.08);
        }
        .pre-letter.cosmic{
            font-family: "Cormorant Garamond", Georgia, "Times New Roman", serif;
            background: linear-gradient(180deg, #f5e6ff, #9ad1ff 60%, #ffd1a1 100%);
            -webkit-background-clip: text; background-clip: text;
            color: transparent; -webkit-text-fill-color: transparent;
            text-shadow:
                    0 0 8px rgba(150,130,255,.25),
                    0 0 18px rgba(120,200,255,.20),
                    0 0 36px rgba(255,200,160,.12);
            animation: glowPulse 6s ease-in-out infinite;
        }
        @keyframes glowPulse{
            0%,100% { filter: brightness(1) drop-shadow(0 0 6px rgba(140,140,255,.25)); }
            50%     { filter: brightness(1.04) drop-shadow(0 0 12px rgba(110,200,255,.28)); }
        }

        .signature{
            margin-top: 16px;
            text-align:right;
            font-family:"Great Vibes", cursive;
            font-size: clamp(26px, 4.8vw, 40px);
            color: var(--accent-2);
            text-shadow: 0 4px 18px rgba(215, 167, 112, .25);
        }

        .actions{
            display:flex; gap:10px; justify-content: space-between;
            align-items: center; margin-top: 14px; flex-wrap: wrap;
        }
        .btn{
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid rgba(190,180,255,.22);
            background: linear-gradient(180deg, #171c34, #12172c);
            color:#e8e5ff;
            cursor:pointer;
            box-shadow: 0 6px 22px rgba(10,12,26,.45);
            transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
        }
        .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 30px rgba(16,18,40,.6); background: linear-gradient(180deg, #1b2240, #141a34); }

        .effect-controls{
            display:flex; gap:8px; flex-wrap: wrap;
        }

        .letter::-webkit-scrollbar{ width: 10px; }
        .letter::-webkit-scrollbar-track{ background: transparent; }
        .letter::-webkit-scrollbar-thumb{
            background: linear-gradient(180deg, #bba8ff, #8ea1ff);
            border-radius: 999px;
        }

        @media (prefers-reduced-motion: reduce){
            .nebula{ animation: none; }
            .hero h1{ animation: none; }
            .pre-letter.cosmic{ animation: none; }
            .paper-to{ animation: none; }
        }

        @media print{
            @page { size: auto; margin: 14mm; } /* Clean margins when saving to PDF */
            body{ background: #fff; color:#000; }
            .bg, .envelope, .scroll-indicator{ display:none !important; }
            .panel{ display:block !important; }
            .card{ box-shadow:none; border:1px solid #ccc; background:#fff; }
            .letter{ max-height: none; overflow: visible; color:#000; }
            .topline{ border: none; padding-bottom:0; margin-bottom:10px; }
            .signature{ color:#000; text-shadow:none; }
            .pre-letter{ background:none !important; color:#000 !important; -webkit-text-fill-color:#000 !important; text-shadow:none !important; }
        }
    </style>
</head>
<body>
<div class="bg" aria-hidden="true">
    <canvas class="stars" id="starsFar"></canvas>
    <canvas class="stars" id="starsMid"></canvas>
    <canvas class="stars" id="starsNear"></canvas>
    <canvas class="stars" id="shooting"></canvas>
    <div class="nebula"></div>
    <div class="vignette"></div>
</div>

<main class="wrap">
    <header class="hero" aria-label="Title">
        <h1>To My Valentine</h1>
        <p class="subtitle">A memoir from <span class="from">Salman</span> through my 1000 year journey under the stars</p>
    </header>

    <section class="envelope" id="envelope">
        <div class="env" role="button" aria-label="Open letter">
            <div class="flap"></div>
            <div class="paper">
                <div class="paper-to"><span class="to-label">To</span> <span class="to-name">[Her Name]</span></div>
                <small class="tap-hint">Tap to reveal your letter</small>
            </div>
            <div class="pocket"></div>
            <div class="seal" aria-hidden="true">❤</div>
        </div>
        <button class="open" id="openBtn" aria-label="Open the envelope">Open</button>
    </section>

    <!-- Letter Panel -->
    <section class="panel" id="panel" aria-live="polite">
        <div class="card">
            <div class="topline">
                <div class="dear">Dear <span class="name">[Recipient]</span>,</div>
                <div class="date">February 14, 2026</div>
            </div>

            <div class="scroll-indicator">
                <span class="arrow">↓</span> Scroll to read the letter <span class="arrow">↓</span>
            </div>

            <div class="body-wrap">
                <div class="letter" id="letter">
<pre class="pre-letter" id="preLetter">
                        My Dearest Ayesha.
My love,
If I were a knight of old, I would not kneel before a throne,
I would kneel before you.

For I have sailed farther in the silence of your presence than
any vessel has crossed upon the sea.
You arrived into my life like the silent tide at dusk, and before
I knew it, my whole world had been encompassed my your ocean.

Ad Astra Abyssosque.
Because for you, Id scale the highest peak and take Olympus.
For you, Id sail the seven seas with my compass always pointed to you.
For you, Id be a pilot a long long time ago in a galaxy far far away.
For you, Id walk into the fires of Mordor because its worth it.
For you, Id String the Bow of a King.
For you, Id shoot an arrow through 13 circles clean.
For you, Id topple empires.
For you, Id wage wars.
For you, Id Die.
For you, Id Live.
For you, Id walk into the heat of battle and say 'I AM HERE!'

To the Stars above and into the Abyss Because I'll find you
at the end.
But then again, you not nerdy enough to understand.

Come rain, come sunshine, come the end of times, I'd only want to
look in your eyes one more time.
With you, I have learned that love is both.
Every time you look at me,
I feel the tides rewrite the shorelines of my soul.
Every time i look at you, I would blind the whole world just so
I only gaze upon a beauty such as your's.

The moon, in all its beauty, it envies you, you know.
It borrows its glow from the sun, but you? You shine from within.
Even in your quiet moments, even when the world presses its weight
upon your shoulders, the light that shines from you, never fades.

You're eyes, like the celestial cosmos, endless and beautiful,
I drown with just a gaze, I get lost and never want to return.

You're smile, like the sunrise, breathing life and light to a
world once asleep, i dont like the sun, but Id take your smile
anyday.

You're Body, curves like a racetrack, each one wakes my soul up and
reminds me that there are perfect things in this world.

If I must wander this universe, through ambition, struggle, and distant horizons.
know this:
I travel not to escape, but to build.
Not to drift, but to return.
For what is a knight without a reason to draw his blade?
What is a voyage without a harbor worth anchoring to?
You are my star and my depth.
My sky and my sea.
And should eternity stretch before us like an endless cosmos,
I would choose to explore it —
hand in hand with you —
again, and again, and again.
Ever yours,
A knight who found his kingdom in your eyes.

Happy Valientines to you, my one true love.
</pre>
                </div>
            </div>

            <div class="signature">
                With all my love,<br>
                <span class="sig">Salman</span>
            </div>
        </div>

        <div class="actions">
            <div class="effect-controls">
                <button class="btn" id="btnDefault" aria-label="Default text style">Default</button>
                <button class="btn" id="btnHand" aria-label="Handwritten effect">Handwritten</button>
                <button class="btn" id="btnCosmic" aria-label="Cosmic glow effect">Cosmic Glow</button>
            </div>
            <div style="display:flex; gap:8px; flex-wrap: wrap;">
                <button class="btn" id="downloadHtmlBtn" aria-label="Download the styled letter as HTML">Download Letter (as shown)</button>
                <button class="btn" id="savePdfBtn" aria-label="Save as PDF">Save as PDF</button>
            </div>
        </div>
    </section>
</main>

<script>
    function Starfield(canvas, options){
        const ctx = canvas.getContext('2d');
        let w, h, stars = [];

        const cfg = Object.assign({
            count: 120,
            size: [0.6, 1.8],
            speed: [0.02, 0.05],
            twinkle: 0.05,
            parallax: 0.3
        }, options||{});

        function resize(){
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            makeStars(); draw(0);
        }
        function rand(min, max){ return Math.random()*(max-min)+min; }
        function makeStars(){
            stars = Array.from({length: cfg.count}).map(()=>({
                x: Math.random()*w,
                y: Math.random()*h,
                r: rand(cfg.size[0], cfg.size[1]),
                a: Math.random()*Math.PI*2,
                s: rand(cfg.speed[0], cfg.speed[1]) * cfg.parallax,
                o: rand(.35, .95),
                hue: rand(210, 300)
            }));
        }

        let mouseX=0, mouseY=0;
        window.addEventListener('mousemove', e=>{
            mouseX = (e.clientX / w - .5);
            mouseY = (e.clientY / h - .5);
        }, {passive:true});

        function draw(){
            ctx.clearRect(0,0,w,h);
            for(const st of stars){
                st.a += st.s * 0.02;
                const tw = (Math.sin(st.a*2)+1)/2 * cfg.twinkle + (1-cfg.twinkle);
                const px = st.x + mouseX * 12 * cfg.parallax;
                const py = st.y + mouseY * 8  * cfg.parallax;
                ctx.beginPath();
                ctx.fillStyle = `hsla(${st.hue}, 70%, 85%, ${st.o*tw})`;
                ctx.arc(px, py, st.r, 0, Math.PI*2);
                ctx.fill();
                const grad = ctx.createRadialGradient(px, py, 0, px, py, st.r*3);
                grad.addColorStop(0, `hsla(${st.hue}, 80%, 85%, ${0.18*tw})`);
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(px, py, st.r*3, 0, Math.PI*2); ctx.fill();
            }
            req = requestAnimationFrame(draw);
        }

        let req;
        resize();
        window.addEventListener('resize', resize);
        return { destroy:()=>cancelAnimationFrame(req) };
    }

    // Shooting stars
    function Shooting(canvas){
        const ctx = canvas.getContext('2d');
        let w, h, trails=[];
        function resize(){ w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
        function spawn(){
            const side = Math.random() < .6 ? 'right' : 'left';
            const x = side==='right' ? w + 60 : -60;
            const y = Math.random()*h*0.6;
            const vx = side==='right' ? - (3 + Math.random()*2) : (3 + Math.random()*2);
            const vy = 1 + Math.random()*1.2;
            const life = 800 + Math.random()*900;
            const hue = 210 + Math.random()*60;
            trails.push({x,y,vx,vy, life, max: life, hue});
        }
        function draw(){
            ctx.clearRect(0,0,w,h);
            ctx.globalCompositeOperation = 'lighter';
            trails = trails.filter(t => t.life>0);
            for(const t of trails){
                const alpha = Math.min(1, t.life / t.max);
                ctx.strokeStyle = `hsla(${t.hue}, 80%, 80%, ${alpha})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(t.x, t.y);
                ctx.lineTo(t.x - t.vx*20, t.y - t.vy*20);
                ctx.stroke();

                ctx.fillStyle = `hsla(${t.hue}, 90%, 90%, ${alpha})`;
                ctx.beginPath(); ctx.arc(t.x, t.y, 2.2, 0, Math.PI*2); ctx.fill();

                t.x += t.vx*2.2; t.y += t.vy*2.2; t.life -= 16;
            }
            requestAnimationFrame(draw);
        }
        resize(); draw();
        window.addEventListener('resize', resize);
        setInterval(()=>{ if(Math.random()<0.7) spawn(); }, 1800);
        setInterval(()=>{ if(Math.random()<0.25) spawn(); }, 600);
    }

    const layerFar = new Starfield(document.getElementById('starsFar'), { count: 120, size:[0.5,1.3], speed:[0.01,0.03], twinkle:0.06, parallax:0.18 });
    const layerMid = new Starfield(document.getElementById('starsMid'), { count: 90,  size:[0.8,1.8], speed:[0.02,0.05], twinkle:0.08, parallax:0.35 });
    const layerNear= new Starfield(document.getElementById('starsNear'),{ count: 60,  size:[1.0,2.2], speed:[0.03,0.06], twinkle:0.10, parallax:0.55 });
    Shooting(document.getElementById('shooting'));

    const envelope = document.getElementById('envelope');
    const panel = document.getElementById('panel');
    const openBtn = document.getElementById('openBtn');

    function openEnvelope(){
        if(envelope.classList.contains('opened')) return;
        envelope.classList.add('opened');
        setTimeout(()=>{
            envelope.style.display = 'none';
            panel.classList.add('show');
            const letter = document.getElementById('letter');
            letter.setAttribute('tabindex', '-1');
            letter.focus({preventScroll:true});
        }, 1150);
    }
    envelope.addEventListener('click', (e)=>{
        if(e.target === openBtn) return;
        openEnvelope();
    });
    openBtn.addEventListener('click', openEnvelope);

    const RECIPIENT = 'Ayesha';
    document.querySelectorAll('.name').forEach(el => el.textContent = RECIPIENT);
    const toName = document.querySelector('.to-name');
    if(toName) toName.textContent = RECIPIENT;
    const seal = document.querySelector('.seal');
    if(seal && RECIPIENT && RECIPIENT.trim().length > 0){
        seal.textContent = RECIPIENT.trim()[0].toUpperCase();
    }

    const pre = document.getElementById('preLetter');
    document.getElementById('btnDefault').addEventListener('click', ()=>{
        pre.classList.remove('handwritten','cosmic');
    });
    document.getElementById('btnHand').addEventListener('click', ()=>{
        pre.classList.add('handwritten');
        pre.classList.remove('cosmic');
    });
    document.getElementById('btnCosmic').addEventListener('click', ()=>{
        pre.classList.add('cosmic');
        pre.classList.remove('handwritten');
    });

    (function(){
        const btn = document.getElementById('downloadHtmlBtn');
        const dearName = (() => {
            const n = document.querySelector('.name'); return n ? n.textContent.trim() : RECIPIENT;
        })();
        const dateText = (() => {
            const d = document.querySelector('.date'); return d ? d.textContent.trim() : '';
        })();
        const sigText = (() => {
            const s = document.querySelector('.sig'); return s ? s.textContent.trim() : '';
        })();

        function todayISO(){
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        }
        function escapeHtml(s){
            return s.replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
        }
        function downloadHtml(filename, html){
            const blob = new Blob([html], {type:'text/html;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }

        btn.addEventListener('click', ()=>{
            const letterText = pre.textContent;
            const handwritten = pre.classList.contains('handwritten');
            const cosmic = pre.classList.contains('cosmic');

            const htmlDoc = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Letter to ${escapeHtml(dearName)}</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&family=Great+Vibes&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#e7e4f7; --accent:#e9c89d; --accent-2:#d7a770;
    --card: rgba(13, 16, 34, .68); --shadow: 0 10px 35px rgba(3,6,20,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; color:var(--ink); background: radial-gradient(1200px 700px at 15% 20%, #151936, #0b0f22 55%, #060814 100%); font-family:"Cormorant Garamond",Georgia,"Times New Roman",serif; padding: 32px 16px;}
  .frame{max-width: 960px; margin: 0 auto;}
  .card{position:relative; background: var(--card); border:1px solid rgba(190,180,255,.18); border-radius:18px; box-shadow: var(--shadow); padding: clamp(18px, 3.4vw, 34px); backdrop-filter: blur(8px) saturate(115%); -webkit-backdrop-filter: blur(8px) saturate(115%);}
  .topline{display:flex; gap:12px; align-items:baseline; justify-content:space-between; border-bottom:1px dashed rgba(190,180,255,.25); padding-bottom:10px; margin-bottom:14px;}
  .dear{font-size: clamp(18px, 3.2vw, 28px); font-weight:600; letter-spacing:.2px;}
  .date{font-size: 14px; color:#bfc6ff; font-style: italic; opacity:.9;}
  .pre{white-space: pre-wrap; overflow-wrap:anywhere; word-wrap:break-word; font-size: clamp(16px, 2.2vw, 20px); line-height:1.7; margin:0; color:inherit; font-family:"Cormorant Garamond",Georgia,"Times New Roman",serif;}
  .pre.handwritten{font-family:"Great Vibes",cursive; font-size: clamp(22px, 5vw, 28px); line-height:1.5; letter-spacing:.2px; transform: rotate(-0.2deg); text-shadow: 0 0.3px 0 rgba(0,0,0,.15), 0.5px 0.5px 0 rgba(0,0,0,.08);}
  .pre.cosmic{background: linear-gradient(180deg, #f5e6ff, #9ad1ff 60%, #ffd1a1 100%); -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent; text-shadow: 0 0 8px rgba(150,130,255,.25), 0 0 18px rgba(120,200,255,.20), 0 0 36px rgba(255,200,160,.12);}
  .signature{margin-top:16px; text-align:right; font-family:"Great Vibes",cursive; font-size: clamp(26px, 4.8vw, 40px); color: var(--accent-2); text-shadow: 0 4px 18px rgba(215,167,112,.25);}
  @media print{
    body{ background:#fff; color:#000; }
    .card{ box-shadow:none; border:1px solid #ccc; background:#fff; }
    .pre{ background:none !important; color:#000 !important; -webkit-text-fill-color:#000 !important; text-shadow:none !important; }
    .signature{ color:#000; text-shadow:none; }
  }
</style>
</head>
<body>
  <div class="frame">
    <div class="card">
      <div class="topline">
        <div class="dear">Dear ${escapeHtml(dearName)},</div>
        <div class="date">${escapeHtml(dateText)}</div>
      </div>
      <pre class="pre ${handwritten ? 'handwritten' : ''} ${cosmic ? 'cosmic' : ''}">${escapeHtml(letterText)}</pre>
      <div class="signature">With all my love,<br><span class="sig">${escapeHtml(sigText || '—')}</span></div>
    </div>
  </div>
</body>
</html>`;

            const filename = `Letter_to_${dearName.replace(/\s+/g,'_')}_${todayISO()}.html`;
            downloadHtml(filename, htmlDoc);
        });
    })();

    (function(){
        const btn = document.getElementById('savePdfBtn');
        if(!btn) return;
        btn.addEventListener('click', ()=>{
            // If envelope is still visible, show the letter for a clean PDF
            const envelope = document.getElementById('envelope');
            const panel = document.getElementById('panel');
            if(panel && !panel.classList.contains('show')){
                envelope.style.display = 'none';
                panel.classList.add('show');
            }
            window.print();
        });
    })();
</script>
</body>
</html>